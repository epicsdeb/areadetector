<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>firewireDCAM: Build Instructions for example</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<h1>Build Instructions for example </h1>  </div>
</div>
<div class="contents">
<p>Build Instructions for example </p>
<ol>
<li>
<p class="startli">Add the dependencies to configure/RELEASE. </p>
<div class="fragment"><pre class="fragment">
BUSY=/dls_sw/prod/R3.14.11/support/busy/1-3dls3
FFMPEGSERVER=/dls_sw/prod/R3.14.11/support/ffmpegServer/1-2
FIREWIREDCAM=/dls_sw/prod/R3.14.11/support/firewireDCAM/1-8
ASYN=/dls_sw/prod/R3.14.11/support/asyn/4-14
DC1394=/dls_sw/prod/R3.14.11/support/dc1394/2-1-2
AREADETECTOR=/dls_sw/prod/R3.14.11/support/areaDetector/1-7beta1
</pre></div><p class="endli"></p>
</li>
<li>
<p class="startli">Add the DBD dependencies to src/Makefile </p>
<div class="fragment"><pre class="fragment">
example_DBD += base.dbd
example_DBD += asyn.dbd
example_DBD += busySupport.dbd
example_DBD += ADSupport.dbd
example_DBD += NDPluginSupport.dbd
example_DBD += firewireDCAM.dbd
example_DBD += ffmpegServer.dbd
</pre></div><p class="endli"></p>
</li>
<li>
<p class="startli">Add the LIBS dependencies to src/Makefile </p>
<div class="fragment"><pre class="fragment">
example_LIBS += ffmpegServer
example_LIBS += firewireDCAM
example_LIBS += dc1394
example_LIBS += NDPlugin
example_LIBS += ADBase
example_LIBS += netCDF
example_LIBS += PvAPI
example_LIBS += GraphicsMagick++
example_LIBS += GraphicsMagickWand
example_LIBS += GraphicsMagick
example_LIBS += NeXus
example_LIBS += mfhdf
example_LIBS += df
example_LIBS += hdf5
example_LIBS += mxml
example_LIBS += busy
example_LIBS += asyn
example_SYS_LIBS += tiff
example_SYS_LIBS += jpeg
example_SYS_LIBS += z
example_SYS_LIBS += gomp
example_SYS_LIBS += X11
example_SYS_LIBS += lcms
example_SYS_LIBS += xml2
example_SYS_LIBS += png12
example_SYS_LIBS += bz2
example_SYS_LIBS += Xext
example_SYS_LIBS += freetype
</pre></div><p class="endli"></p>
</li>
<li>
<p class="startli">Use the template files to add records to the database. </p>
<div class="fragment"><pre class="fragment">

# Macros:
#  P        Device Prefix
#  R        Device Suffix
#  PORT     Asyn Port name
#  TIMEOUT  Timeout
#  ADDR     Asyn Port address
file $(AREADETECTOR)/db/ADBase.template
{
pattern { P, R, PORT, TIMEOUT, ADDR }
    { "TESTFWDCAM1", ":CAM:", "CAM1.CAM", "1", "0" }
    { "TESTFWDCAM2", ":CAM:", "CAM2.CAM", "1", "0" }
}

# Macros:
#  P      Device Prefix
#  R      Device Suffix
#  PORT   Asyn Port name
#  FR     Max framerate enum
#  DUMMY  Dummy empty macro to satisfy vdct
file $(FIREWIREDCAM)/db/firewireDCAM.template
{
pattern { P, R, PORT, FR, DUMMY }
    { "TESTFWDCAM1", ":CAM:", "CAM1.CAM", "3", "" }
    { "TESTFWDCAM2", ":CAM:", "CAM2.CAM", "3", "" }
}

# Macros:
#  P             Device Prefix
#  R             Device Suffix
#  PORT          Asyn Port name
#  TIMEOUT       Timeout
#  ADDR          Asyn Port address
#  NDARRAY_PORT  Input Array Port
#  NDARRAY_ADDR  Input Array Address
#  Enabled       Plugin Enabled at startup?
file $(AREADETECTOR)/db/NDPluginBase.template
{
pattern { P, R, PORT, TIMEOUT, ADDR, NDARRAY_PORT, NDARRAY_ADDR, Enabled }
    { "TESTFWDCAM1", ":CC:", "CAM1.CC", "1", "0", "CAM1.CAM", "0", "1" }
    { "TESTFWDCAM2", ":CC:", "CAM2.CC", "1", "0", "CAM2.CAM", "0", "1" }
    { "TESTFWDCAM1", ":ARR:", "CAM1.ARR", "1", "0", "CAM1.CAM", "0", "1" }
    { "TESTFWDCAM2", ":ARR:", "CAM2.ARR", "1", "0", "CAM2.CAM", "0", "1" }
    { "TESTFWDCAM1", ":MJPG:", "CAM1.MJPG", "1", "0", "CAM1.CC", "0", "1" }
    { "TESTFWDCAM2", ":MJPG:", "CAM2.MJPG", "1", "0", "CAM2.CC", "0", "1" }
}

# Macros:
#  P        Device Prefix
#  R        Device Suffix
#  PORT     Asyn Port name
#  TIMEOUT  Timeout
#  ADDR     Asyn Port address
file $(AREADETECTOR)/db/NDColorConvert.template
{
pattern { P, R, PORT, TIMEOUT, ADDR }
    { "TESTFWDCAM1", ":CC:", "CAM1.CC", "1", "0" }
    { "TESTFWDCAM2", ":CC:", "CAM2.CC", "1", "0" }
}

# Macros:
#  P          Device Prefix
#  R          Device Suffix
#  PORT       Asyn Port name
#  TIMEOUT    Timeout
#  ADDR       Asyn Port address
#  TYPE       Asyn Type e.g. Int32
#  FTVL       Format, e.g. Int
#  NELEMENTS  Number of elements
file $(AREADETECTOR)/db/NDStdArrays.template
{
pattern { P, R, PORT, TIMEOUT, ADDR, TYPE, FTVL, NELEMENTS }
    { "TESTFWDCAM1", ":ARR:", "CAM1.ARR", "1", "0", "Int16", "USHORT", "1228800" }
    { "TESTFWDCAM2", ":ARR:", "CAM2.ARR", "1", "0", "Int16", "USHORT", "1228800" }
}

# Macros:
#  P        Device Prefix
#  R        Device Suffix
#  PORT     Asyn Port name
#  QUALITY  Jpeg Quality in percent
file $(FFMPEGSERVER)/db/ffmpegStream.template
{
pattern { P, R, PORT, QUALITY }
    { "TESTFWDCAM1", ":MJPG:", "CAM1.MJPG", "100" }
    { "TESTFWDCAM2", ":MJPG:", "CAM2.MJPG", "100" }
}
</pre></div><p class="endli"></p>
</li>
<li>
Add the startup commands to st.cmd <div class="fragment"><pre class="fragment">

# Loading libraries
# -----------------

# Device initialisation
# ---------------------

cd "$(TOP)"

dbLoadDatabase "dbd/example.dbd"
example_registerRecordDeviceDriver(pdbbase)

# Scan the firewire bus for cameras
FDC_InitBus()
# FDC_Config(asynPort, cameraID, busSpeed, nBuffers, maxMemory, disableScalable)
FDC_Config("CAM1.CAM", 0x00B09D01006F677D, 800, 50, -1, 0)

# FDC_Config(asynPort, cameraID, busSpeed, nBuffers, maxMemory, disableScalable)
FDC_Config("CAM2.CAM", 0x00B09D01008ADB4F, 800, 50, -1, 0)

# NDColorConvertConfigure(portName, queueSize, blockingCallbacks, NDArrayPort, NDArrayAddr, maxBuffers, maxMemory)
NDColorConvertConfigure("CAM1.CC", 16, 0, "CAM1.CAM", 0, 50, -1)

# NDColorConvertConfigure(portName, queueSize, blockingCallbacks, NDArrayPort, NDArrayAddr, maxBuffers, maxMemory)
NDColorConvertConfigure("CAM2.CC", 16, 0, "CAM2.CAM", 0, 50, -1)

# NDStdArraysConfigure(portName, queueSize, blockingCallbacks, NDArrayPort, NDArrayAddr, maxMemory)
NDStdArraysConfigure("CAM1.ARR", 2, 0, "CAM1.CAM", 0, -1)

# NDStdArraysConfigure(portName, queueSize, blockingCallbacks, NDArrayPort, NDArrayAddr, maxMemory)
NDStdArraysConfigure("CAM2.ARR", 2, 0, "CAM2.CAM", 0, -1)

ffmpegServerConfigure(8080)
# ffmpegStreamConfigure(portName, queueSize, blockingCallbacks, NDArrayPort, NDArrayAddr, maxMemory)
ffmpegStreamConfigure("CAM1.MJPG", 2, 0, "CAM1.CC", "0", -1)

# ffmpegStreamConfigure(portName, queueSize, blockingCallbacks, NDArrayPort, NDArrayAddr, maxMemory)
ffmpegStreamConfigure("CAM2.MJPG", 2, 0, "CAM2.CC", "0", -1)
</pre></div> </li>
</ol>
<p>These build instructions assume some knowledge of building EPICS modules. It is a requirement that <a href="http://www.aps.anl.gov/epics/base/index.php">EPICS base</a> has already been downloaded and successfully build with all the common environment variables set.</p>
<h2><a class="anchor" id="dependencies"></a>
Dependencies</h2>
<h3><a class="anchor" id="epics_base_and_modules"></a>
EPICS base and modules</h3>
<ul>
<li>EPICS base <a href="http://www.aps.anl.gov/epics/base/R3-14/11.php">R3.14.11</a> </li>
<li><a href="http://www.aps.anl.gov/epics/modules/soft/asyn">asyn</a> 4-14 </li>
<li><a href="http://cars9.uchicago.edu/software/epics/areaDetector.html">areaDetector</a> 1-7beta1</li>
</ul>
<h3><a class="anchor" id="optional_dependencies"></a>
Optional Dependencies</h3>
<p>The <a href="http://controls.diamond.ac.uk/downloads/support/ffmpegServer">ffmpegServer</a> module is recommended for new firewire (or any areaDetector) IOCs. This plugin provide mjpeg compression and with the <a href="http://controls.diamond.ac.uk/downloads/support/nullhttpd">nullhttpd</a> module also http streaming for client side image viewing. It also provides a QT/OpenGL based viewer application.</p>
<h3><a class="anchor" id="Firewire"></a>
IIDC DCAM libraries</h3>
<p>The Linux firewire camera support libraries are: </p>
<ul>
<li><a href="http://sourceforge.net/project/showfiles.php?group_id=8157">libdc1394</a> 2.1.2 </li>
<li><a href="http://www.linux1394.org/download.php">libraw1394</a> 1.3.0</li>
</ul>
<h2><a class="anchor" id="kernel_libs"></a>
Kernel Modules</h2>
<p>The libdc1394 and libraw1394 libraries depend on a set of drivers/kernel modules that will need to be loaded. There are basically two options when selecting the firewire kernel modules: the traditional ohci1394 (and friends) or the newer 'Juju' stack. Most distributions (with the notable exception of Fedora 6+ and RHEL5+) ship with the traditional firewire stack. The 'Juju' stack removes the requirement to use the raw1394 kernel module.</p>
<p>Recently we have begun testing the newer 'Juju' stack but have yet to use this in production systems so all instructions here refer to the old firewire stack.</p>
<p>However, this new kernel module does appear to work well and is recommended for new setups. The firewireDCAM module does not need any modifications to work with either linux firewire modules. libdc1394 in recent versions will also work with either kernel module without the need for recompilation.</p>
<p>Depending on Linux distribution and kernel configuration the firewire kernel modules may need to be loaded as root using the modprobe command. For instance for the traditional firewire stack you will typically need to do: </p>
<div class="fragment"><pre class="fragment">
/sbin/modprobe video1394
/sbin/modprobe raw1394
</pre></div><p>When using the traditional firewire stack the following command can inform if the correct kernel modules have been loaded: </p>
<div class="fragment"><pre class="fragment">
[up45@pc0033 example] /sbin/lsmod | grep 1394
video1394              21273  0
raw1394                29753  0
ohci1394               35845  1 video1394
ieee1394              293753  3 video1394,raw1394,ohci1394
</pre></div><h3><a class="anchor" id="device_permissions"></a>
Device Permissions</h3>
<p>Once the kernel modules are loaded you must ensure that the user that will run the IOC application has read+write permissions on the necessary device files. The files in question can be checked for permissions with the following commands: </p>
<div class="fragment"><pre class="fragment">
[up45@pc0033 ~] ls -al /dev/video1394/*
crw-rw-rw- 1 root root 171, 16 Sep 30 11:04 /dev/video1394/0
[up45@pc0033 ~] ls -al /dev/raw1394
crw-rw-rw- 1 root root 171, 0 Sep 30 11:04 /dev/raw1394
</pre></div><h2><a class="anchor" id="building_1394_libs"></a>
Building the 1394 libraries</h2>
<p>Please check the INSTALL or README files provided with the 1394 libraries for installation notes. Libraw1394 need to be build before libdc1394 to get the dependencies right.</p>
<p>The basic build and installation is fairly simple (the last step possibly as root, depending on the installation location): </p>
<div class="fragment"><pre class="fragment">
./configure
make
make install
</pre></div><p>However, in order to build the firewireDCAM module within the EPICS framework it is suggested to build the 1394 libraries in a way so they can appear as an EPICS support module. I.e. let the libraries be build into a lib/linux-x86/ directory. This can be achieved with the following commands (same commands apply for libdc1394): </p>
<div class="fragment"><pre class="fragment">
tar -zxf libraw1394-1.3.0.tar.gz
cd libraw1394-1.3.0
./configure --bindir=/my/raw1394/install/dir/bin/linux-x86 \
            --libdir=/my/raw1394/install/dir/lib/linux-x86 \
            --datarootdir=/my/raw1394/install/dir/doc \
            --prefix=/my/raw1394/install/dir
make
make install
</pre></div><p>Tarballs with suitable makefiles and configure directory can be supplied if requested to ease the building of these libraries as 'EPICS modules'.</p>
<p>If you choose to install the libdc1394 and raw1394 libraries in their default location, you will need to edit the your IOC's src/Makefile to point the build system to the right path where it can find the library files. See <a class="el" href="example_2exampleApp_2src_2Makefile.html">example/exampleApp/src/Makefile</a> as an example and note the comments. Also remember to remove the corresponding dc1394 and raw1394 dependency lines from configure/RELEASE.</p>
<h2><a class="anchor" id="building_firewireDCAM"></a>
Building firewireDCAM</h2>
<p>The building of this module is almost like building any other EPICS support module: </p>
<ul>
<li>Build the 1394 libraries as described above. </li>
<li>Build the EPICS support modules listed under dependencies. </li>
<li>Edit the firewireDCAM/configure/RELEASE file to point to the file paths where the dependencies and EPICS base are installed. </li>
<li>Build with the make command. </li>
<li>Optionally: Build the example<ul>
<li>Edit example/configure/RELEASE to point to all dependency modules</li>
<li>Possibly modify example/exampleApp/src/Makefile if you have installed the 1394 libraries in a custom location (see above)</li>
<li>cd example; make </li>
</ul>
</li>
</ul>
</div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address class="footer"><small>Generated on Fri Feb 25 2011 13:34:31 for firewireDCAM by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
